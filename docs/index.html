<!DOCTYPE html><html lang="en"><head>  
  <link rel="modulepreload" href="/taskmaster/assets/vendor.16792e99.js">
  <link rel="stylesheet" href="/taskmaster/assets/index.11684af4.css">
<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/scottorly/scottorly.github.io/main/fav.png"><meta name="Description" content="iOS UI programming with Swift Concurrency."><meta name="twitter:title" content="TASKMASTER"><meta name="twitter:description" content="iOS UI programming with Swift Concurrency."><meta name="twitter:image" content="https://github.com/scottorly/taskmaster/raw/main/thumbnail.png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="https://scottorly.github.io/taskmaster"><meta name="twitter:creator" content="@orlyck"><meta property="og:url" content="https://scottorly.github.io/taskmaster"><meta property="og:title" content="TASKMASTER"><meta property="og:description" content="iOS UI programming with Swift Concurrency."><meta property="og:image" content="https://github.com/scottorly/taskmaster/raw/main/thumbnail.png"><meta property="og:image:secure" content="https://github.com/scottorly/taskmaster/raw/main/thumbnail.png"></head>
    
<body>
<article><section><h1>TASKMASTER</h1><p class="subtitle"><a href="https://scottorly.github.io">Scott Orlyck</a></p></section><section><figure><label for="1" class="margin-toggle">⊕</label><input type="checkbox" id="1" class="margin-toggle"><span class="marginnote">New way to dispatch to main dropped.<br><pre class="language-swift" tabindex="0"><code class="code language-swift"><span class="token class-name">Task</span> <span class="token punctuation">{</span> <span class="token attribute atrule">@MainActor</span> <span class="token keyword">in</span>

<span class="token punctuation">}</span>
</code></pre><em>Not that you should ever need to use it.</em></span><label for="2" class="margin-toggle">⊕</label><input type="checkbox" id="2" class="margin-toggle"><span class="marginnote"></span><img src="/taskmaster/assets/taskmaster.e748c7ff.jpg" alt="Taskmaster in Marvel's Black Widow. (Marvel Studios)"><em>Black Widow<br>Marvel Studios</em><blockquote>ALL HANDS, ON SIGHT</blockquote></figure></section><section><h2><em>SWIFT CONCURRENCY</em></h2><p><span class="newthought"><a target="_blank" rel="noreferrer noopener" href="https://scottorly.github.io/drive">First</a> I demonstrated some practical</span> RxSwift &amp; UIKit UI programming techniques. <a target="_blank" rel="noreferrer noopener" href="https://scottorly.github.io/drive2combine">Next</a> I showed you how to do the same thing using Swift's Combine reactive framework and UIKit.</p><p>Now for something slightly different. Swift's new concurrency language features potentially offer the ability to design clean, minimalist architectures without the burdensome complexity of reactive programming language extensions because while Rx is absurdly powerful, it is not for everyone.</p><p>Since the earliest days of iOS development, dealing with asynchronous operations was cumbersome and limited by the ancient ways of Objective-C, the target-action/delegate pattern, Model-View-Controller, and the fact that UI update operations are required to use the main thread.</p><p>In an effort to avoid getting Italian food<label for="1a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="1a" class="margin-toggle"><span class="sidenote">Spagehtti code: little or no seperation of concerns.</span> all over the walls, alternatives architectures for iOS proliferated like memory leaks.</p><p>My favorite flavor of over-cooked lasagna<label for="2a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="2a" class="margin-toggle"><span class="sidenote">The opposite of spagehtti code: excessive seperation of concerns.</span> was a pecuilar Promise based Model-View-Presenter pattern in a misguided attempt to avoid MVC by mimicking the architectures of Javascript web applications using Objective-C. Whatever the case, I think everyone can agree that anything is better than the commonly encountered anti-pattern of relying on NotificationCenter to broadcast the results of asynchronous operations.</p></section><section><h2>CONCURRENCY</h2><p><label for="3" class="margin-toggle">⊕</label><input type="checkbox" id="3" class="margin-toggle"><span class="marginnote">XCode Playground file with working example available <a target="_blank" rel="noreferrer noopener" href="https://github.com/scottorly/taskmaster/TASKMASTER.playground">here</a>.</span>The new concurrency language features in Swift are <em>extensive</em> and the selection of tools is overwhelming at first. However, learn a select few of the new standard library additions and before you know it you'll be writing classes and methods so linear they'll only look synchronous.</p><p>There are 4 specific Swift language features or standard library additions that are going to provide the flexibilty for a clean, linear architecture: <a target="_blank" rel="noreferrer noopener" href="https://docs.swift.org/swift-book/LanguageGuide/Concurrency.htm">asynchronous functions</a>, <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/swift/result">Result</a>, <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/swift/task">Task</a>, &amp; Actors<label for="3a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="3a" class="margin-toggle"><span class="sidenote">Specifically the <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/swift/mainactor">MainActor</a> and the @MainActor attribute.</span>.</p><p>The example shared in this post is over-simplified. There is no stipulation that wrapping asynchronous functions in a Task cannot be used directly in a ViewController. UIViewController already has the MainActor attribute, nevertheless, the complexity of seemingly simple real-world production applications warrants a more thoughtful approach to separation of concerns.</p><p><label for="4" class="margin-toggle">⊕</label><input type="checkbox" id="4" class="margin-toggle"><span class="marginnote">A simple mock Network service definition with an asynchronous method that returns a Result type wrapping an error or success case in an associated value.</span></p><figure class="small"><pre data-line="" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token keyword">import</span> <span class="token class-name">UIKit</span>

<span class="token keyword">enum</span> <span class="token class-name">NetworkError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token function">httpError</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Network</span> <span class="token punctuation">{</span>

    <span class="token comment">//simulate a network call</span>
    <span class="token keyword">func</span> <span class="token function-definition function">fetchList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">NetworkError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>nanoseconds<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1_000_000_000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">httpError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"bar"</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre></figure><p>Nothing innovative going on above, just catching some Zs to mimic an asynchronous network request. Note the use of the Result type to wrap the response allowing the method to return an error state<label for="4a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="4a" class="margin-toggle"><span class="sidenote">Async/await also plays nice with Swift error handling via <em>throws</em> if you want to be a <em>try</em>hard.</span>.</p></section><section><h2>MAIN ACTOR</h2><p>This is going to be a short post because these new concurrency features make it dumb easy to handle this stuff now.</p><p></p><figure class="small"><pre data-line="" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token attribute atrule">@MainActor</span>
<span class="token keyword">class</span> <span class="token class-name">ViewModel</span> <span class="token punctuation">{</span>

    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> errorMessage<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>

    <span class="token keyword">let</span> network<span class="token punctuation">:</span> <span class="token class-name">Network</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>network<span class="token punctuation">:</span> <span class="token class-name">Network</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>network <span class="token operator">=</span> network
        <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token class-name">Task</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> response <span class="token operator">=</span>  <span class="token keyword">await</span> network<span class="token punctuation">.</span><span class="token function">fetchList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">let</span> listResponse<span class="token punctuation">)</span> <span class="token operator">=</span> response <span class="token punctuation">{</span>
                list <span class="token operator">+=</span> listResponse
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token keyword">let</span> error<span class="token punctuation">)</span> <span class="token operator">=</span> response <span class="token punctuation">{</span>
                errorMessage <span class="token operator">=</span> error<span class="token punctuation">.</span>localizedDescription
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></figure><p><label for="5" class="margin-toggle">⊕</label><input type="checkbox" id="5" class="margin-toggle"><span class="marginnote">Readers with a background in Javascript should note that asynchronous functions in Swift are not syntactic sugar around Promises as in ES6, rather async/await is part of the <a target="_blank" rel="noreferrer noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0296-async-await.md">Swift type system</a>.<br><br>Swift has a Future type but it is a Combine Publisher and not an implementation of Promises per se.</span>The MainActor attribute used together with the Task wrapper means we don't have to worry about manually dispatching to the main queue. Task allows us to call asynchronous methods without capturing weak self and polluting our code with unwrapped optionals all over the place. Returning results wrapped in the Result type provides the flexibilty to preserve success/error states in the UI layer, and finally the Publisher wrapped property provides a ready-made ViewModel output for our ViewController to subscribe to.</p></section><section><h2>BUT WAIT, THERE'S MORE</h2><p>What is the point of this squeaky clean architecture if it isn't tested? What about some more complicated examples?</p><p>For that you will have to wait for next time.</p></section><section><h3>Acknowledgements</h3><p>Styles by <a target="_blank" rel="noreferrer noopener" href="https://edwardtufte.github.io/tufte-css/">Tufte-CSS</a>.</p><p>Syntax by <a target="_blank" rel="noreferrer noopener" href="https://prismjs.com/">PrismJS</a></p></section><footer><em>Copyright © 2022 Scott Orlyck. All rights reserved.</em></footer></article></body></html>