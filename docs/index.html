<!DOCTYPE html><html lang="en"><head>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta charset="utf-8">
      
      
      <link rel="stylesheet" href="/taskmaster/assets/index.3020368f.css">
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/scottorly/scottorly.github.io/main/fav.png"><meta name="Description" content="iOS UI programming with Swift Concurrency."><meta name="twitter:title" content="TASKMASTER"><meta name="twitter:description" content="iOS UI programming with Swift Concurrency."><meta name="twitter:image" content="https://github.com/scottorly/taskmaster/raw/main/thumbnail.png"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="https://scottorly.github.io/taskmaster"><meta name="twitter:creator" content="@orlyck"><meta property="og:url" content="https://scottorly.github.io/taskmaster"><meta property="og:title" content="TASKMASTER"><meta property="og:description" content="iOS UI programming with Swift Concurrency."><meta property="og:image" content="https://github.com/scottorly/taskmaster/raw/main/thumbnail.png"><meta property="og:image:secure" content="https://github.com/scottorly/taskmaster/raw/main/thumbnail.png"></head>
    
<body>
<article><section><h1>TASKMASTER</h1><p class="subtitle"><a href="https://scottorly.github.io">Scott Orlyck</a></p></section><section><figure><label for="1" class="margin-toggle">⊕</label><input type="checkbox" id="1" class="margin-toggle"><span class="marginnote">New way to dispatch to main dropped.<br><pre class="language-swift" tabindex="0"><code class="code language-swift"><span class="token class-name">Task</span> <span class="token punctuation">{</span> <span class="token attribute atrule">@MainActor</span> <span class="token keyword">in</span>

<span class="token punctuation">}</span>
</code></pre><em>Not that you should ever need to use it.</em></span><img src="/taskmaster/assets/taskmaster.e748c7ff.jpg" alt="Taskmaster in Marvel's Black Widow. (Marvel Studios)"><em>Black Widow<br>Marvel Studios</em><blockquote>ALL HANDS, ON SIGHT</blockquote></figure></section><section><p><span class="newthought"><a target="_blank" rel="noreferrer noopener" href="https://scottorly.github.io/drive">First</a> I demonstrated some practical</span> RxSwift and UIKit UI programming techniques. <a target="_blank" rel="noreferrer noopener" href="https://scottorly.github.io/drive2combine">Next</a> I showed you how to do the same thing using Swift's Combine reactive framework and UIKit.</p><p>Now for something slightly different. Swift's new concurrency language features potentially offer the ability to design clean, minimalist architectures without the burdensome complexity of reactive programming language extensions because while Rx is absurdly powerful, it is not for everyone.</p><p>Since the earliest days of iOS development, dealing with asynchronous operations was cumbersome and limited by the ancient ways of Objective-C, the target-action/delegate pattern, Model-View-Controller, and the fact that UI update operations are required to use the main thread.</p><p>In an effort to avoid getting Italian food<label for="1a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="1a" class="margin-toggle"><span class="sidenote">Spagehtti code is little or no seperation of concerns.</span> all over the walls, alternative architectures for iOS proliferated like memory leaks.</p><p>Of course, some took it too far and the result is over-cooked lasagna.<label for="2a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="2a" class="margin-toggle"><span class="sidenote">The opposite of spagehtti is excessive seperation of concerns.</span> I think the most peculiar MVC avoidance I have encountered was a Promise based Model-View-Presenter pattern in a misguided attempt to mimic the architectures of Javascript web applications in Objective-C. Whatever the case, I think everyone can agree that anything is better than the commonly encountered anti-pattern of relying on NotificationCenter to broadcast the results of asynchronous operations.</p></section><section><h2>SWIFT CONCURRENCY</h2><p><label for="2" class="margin-toggle">⊕</label><input type="checkbox" id="2" class="margin-toggle"><span class="marginnote">XCode Playground file with working example available <a target="_blank" rel="noreferrer noopener" href="https://github.com/scottorly/taskmaster/tree/main/TASKMASTER.playground">here</a>.</span>The new concurrency language features in Swift are <em>extensive</em> and the selection of tools is overwhelming at first but learn a select few and before you know it you'll be writing functions so linear they'll only look synchronous.</p><p>There are 4 specific Swift language features or standard library additions that are going to provide the flexibilty for a clean, linear architecture: <a target="_blank" rel="noreferrer noopener" href="https://docs.swift.org/swift-book/LanguageGuide/Concurrency.htm">asynchronous functions</a>, <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/swift/result"><code>Result</code></a>, <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/swift/task"><code>Task</code></a>, &amp; Actors<label for="3a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="3a" class="margin-toggle"><span class="sidenote">Specifically the <a target="_blank" rel="noreferrer noopener" href="https://developer.apple.com/documentation/swift/mainactor"><code>MainActor</code></a> and the <code>@MainActor</code> attribute.</span>. What I like about this approach is that in addition to the simplicity of asynchronous functions and actors it doesn't require any external dependencies.</p><p><label for="3" class="margin-toggle">⊕</label><input type="checkbox" id="3" class="margin-toggle"><span class="marginnote">A simple mock Network service definition with an asynchronous method that returns a <code>Result</code> type wrapping an error or success case in an associated value.</span></p><figure class="small"><pre data-line="" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token keyword">import</span> <span class="token class-name">UIKit</span>

<span class="token keyword">enum</span> <span class="token class-name">NetworkError</span><span class="token punctuation">:</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token function">httpError</span><span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Network</span> <span class="token punctuation">{</span>

    <span class="token comment">//simulate a network call</span>
    <span class="token keyword">func</span> <span class="token function-definition function">fetchList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token operator">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">NetworkError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token keyword">await</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>nanoseconds<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1_000_000_000</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token keyword">let</span> error <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">httpError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"foo"</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"bar"</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre></figure><p>Nothing innovative going on above, just catching some Zs to mimic an asynchronous network request. Note the use of the Result type to wrap the response allowing the method to return an error state<label for="4a" class="margin-toggle sidenote-number"></label><input type="checkbox" id="4a" class="margin-toggle"><span class="sidenote">Async/await also plays nice with Swift error handling via <em>throws</em> if you want to be a <em>try</em>hard.</span>.</p></section><section><h2>MAIN ACTOR &amp; UNSTRUCTURED TASK</h2><p>This is going to be a short post because these new concurrency features make it dumb easy to handle this stuff now.</p><p>Basically all we need to do is define our asynchronous methods on a given service entity that communicates with the ViewModel. Before async/await and actors this would mean that we would have to choose which closure to dispatch to the main thread in or indicate that a Combine publisher would notifify subscribers of events on the main thread. Now just use the <code>@MainActor</code> attribute and wrap an asynchronous method call in an unstructured <code>Task</code> and that is it.</p><p>There is no stipulation that wrapping asynchronous functions in a <code>Task</code> cannot be used directly in a <code>UIViewController</code> as it already has the <code>@MainActor</code> attribute. Nevertheless, the surprising complexity of seemingly simple real-world production applications always warrants thoughtful consideration to separation of concerns so our code is always tidy, side-effect free, easy to test, easy to debug, and easy to change.</p><p></p><figure class="small"><pre data-line="" class="language-swift" tabindex="0"><code class="code language-swift"><span class="token attribute atrule">@MainActor</span>
<span class="token keyword">class</span> <span class="token class-name">ViewModel</span> <span class="token punctuation">{</span>

    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token attribute atrule">@Published</span> <span class="token keyword">var</span> errorMessage<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span>

    <span class="token keyword">let</span> network<span class="token punctuation">:</span> <span class="token class-name">Network</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>network<span class="token punctuation">:</span> <span class="token class-name">Network</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>network <span class="token operator">=</span> network
        <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function-definition function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token class-name">Task</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> response <span class="token operator">=</span>  <span class="token keyword">await</span> network<span class="token punctuation">.</span><span class="token function">fetchList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">let</span> listResponse<span class="token punctuation">)</span> <span class="token operator">=</span> response <span class="token punctuation">{</span>
                list <span class="token operator">+=</span> listResponse
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token keyword">let</span> error<span class="token punctuation">)</span> <span class="token operator">=</span> response <span class="token punctuation">{</span>
                errorMessage <span class="token operator">=</span> error<span class="token punctuation">.</span>localizedDescription
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></figure><p><label for="4" class="margin-toggle">⊕</label><input type="checkbox" id="4" class="margin-toggle"><span class="marginnote">Readers with a background in Javascript should note that asynchronous functions in Swift are not syntactic sugar around Promises as in ES6, rather async/await is part of the <a target="_blank" rel="noreferrer noopener" href="https://github.com/apple/swift-evolution/blob/main/proposals/0296-async-await.md">Swift type system</a>.<br><br>Swift has a Future type but it is a Combine Publisher and not an implementation of Promises per se.</span>The <code>MainActor</code> attribute used together with the <code>Task</code> wrapper means we don't have to worry about manually dispatching to the main queue. <code>Task</code> allows us to call asynchronous methods without capturing weak self and polluting our code with unwrapped optionals all over the place. Returning results wrapped in the <code>Result</code> type provides the flexibilty to preserve success/error states in the UI layer, and finally the <code>Publisher</code> wrapped property provides ready-made outputs for our <code>ViewController</code> to subscribe to.</p></section><section><h2>BUT WAIT</h2><p>What is the point of this squeaky clean architecture if it isn't tested? What about some more complicated examples using structured concurrency?</p><p>For that you will have to wait for next time.</p></section><section></section><footer><p>Styled with <a target="_blank" rel="noreferrer noopener" href="https://edwardtufte.github.io/tufte-css/">Tufte-CSS</a> &amp; <a target="_blank" rel="noreferrer noopener" href="https://prismjs.com/">PrismJS</a></p><em>Copyright © 2022 Scott Orlyck. All rights reserved.</em></footer></article></body></html>